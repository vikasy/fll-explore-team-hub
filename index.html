<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Firebase SDKs: MUST be first in <head> -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script>
    // Firestore-based allowlist: check if user email is allowed in Firestore

  // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD3nbgoGy4LKZDWV8ILDsHmTQceNg1lE2c",
      authDomain: "fllex2wv.firebaseapp.com",
      projectId: "fllex2wv",
      storageBucket: "fllex2wv.appspot.com",
      messagingSenderId: "105509048133",
      appId: "1:105509048133:web:2655ec171befe83d09b82c"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    if (firebase.analytics) {
      firebase.analytics();
    }
    // Initialize Firestore
    const db = firebase.firestore();
    console.log('[Firebase] Initialized');
  </script>
  <!-- ReCAPTCHA (commented out)
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LfyaMkrAAAAAFkhIoQRjBoczSOuJUfisa54HzNi"></script>
  <script>
    function onSubmit(token) {
      document.getElementById("demo-form").submit();
    }
  </script>
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WV FLL Explore FLLEX2WV Hub</title>
  <!--
    This simple static portal provides a central hub for a FIRST LEGO League Explore team.
    It loads a season timeline and a roster from CSV files in the same directory and
    presents them in a table. A lightweight to‑do list uses the browser's localStorage
    to store tasks. Replace the placeholder in the calendar section with an embedded
    Google Calendar iframe to show your team's schedule.
  -->
  <style>
    :root {
      --primary-color: #0052a3;
      --secondary-color: #e7f1ff;
      --light-bg: #f5f5f5;
      --border-color: #dddddd;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--light-bg);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: var(--primary-color);
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    main {
      flex: 1;
      padding: 1rem;
      /* Set a flexible width so the layout shrinks on small screens. On larger displays the content is constrained to 1000px, but on phones and tablets it can collapse down to 100% of the viewport width. */
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
    }
    section {
      margin-bottom: 2rem;
    }
    h2 {
      margin-top: 0;
      color: var(--primary-color);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    th,
    td {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      text-align: left;
    }
    th {
      background-color: var(--secondary-color);
      font-weight: bold;
    }
    /* Timeline color coding */
    .timeline-past {
      background-color: #f0f0f0;
      color: #888;
    }
    .timeline-next {
      background-color: #fff3cd;
      color: #856404;
      font-weight: bold;
    }
    .timeline-future {
      background-color: #e7f1ff;
      color: #0052a3;
    }
  /* Task list styling */
    #task-list {
      list-style: none;
      padding: 0;
    }
    #task-list li {
      background: #fff;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      flex-direction: row;
      flex-wrap: wrap;
    }
    #task-list li span, #task-list li input[type="checkbox"] {
      margin-left: 1rem;
    }
    #task-list li button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      margin-left: auto;
    }
    #task-input {
      padding: 0.5rem;
      width: 70%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    #task-add {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #logout-btn {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }  
    #login-btn {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  
    /* Responsive adjustments for small screens */
    @media (max-width: 600px) {
      #task-input {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      #task-add {
        width: 100%;
        margin-left: 0;
      }
      iframe {
        height: 400px;
      }
    }
  </style>
  <style>
    #email-login-btn {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #email-input {
      padding: 0.5rem;
      width: 70%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    #password-input {
      padding: 0.5rem;
      width: 70%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <header style="background:#0052a3;color:#fff;padding:1rem;text-align:center;">
    <h1 style="margin:0;">West Valley Elementary FLL Explore Team 2 [FLLEX2WV] Hub</h1>
  </header>
  <div class="main-bounding-box">
  <main>
  <section id="welcome">
    <!-- The illustration is loaded from the repository root as team_cartoon.png -->
  <img src="images/IMG_5632.png" alt="Kid with a robot" style="max-width:85%;height:auto;display:block;margin:0 auto 1rem;" />
    <p style="text-align:center;font-size:1.2rem;">West Valley Elementary FIRST LEGO League </p>
    <p style="text-align:center;font-size:1.2rem;"> Explore Team #2 aka FLLEX2WV </p>
    <p style="text-align:center;">
      Our school: 
      <a href="https://westvalley.cusdk8.org" target="_blank" style="color: var(--primary-color); text-decoration: underline;">
        West Valley Elementary School
      </a>
    </p>
    <!-- Easy link to access this portal -->
    <p style="text-align:center;">
      Simple URL:
      <a href="https://westvalley.short.gy/fllexplore" target="_blank" style="color: var(--primary-color); text-decoration: underline;">
        westvalley.short.gy/fllexplore
      </a>
    </p>
    <!-- Resource links -->
    <p style="text-align:center;">
      <a href="https://www.firstinspires.org/resource-library/fll/explore/challenge-and-resources" target="_blank" style="color: var(--primary-color); text-decoration: underline;">
        FLL Resources page
      </a>:
      <a href="documents/fll-explore-unearthed-tmg.pdf" target="_blank" style="color: var(--primary-color); text-decoration: underline;">
        Team Meeting Guide PDF
      </a>
    </p>
  </section>
  <section id="login-section" style="text-align:center; margin-top:2rem;">
    <div id="auth-controls" style="margin-bottom:1rem;">
      <button id="login-btn">Login with Google</button>
      <span id="user-info" style="margin-left:1rem;"></span>
    </div>
    <!--
    <div id="email-auth-form" style="max-width:350px;margin:1rem auto;">
      <input type="email" id="email-input" placeholder="Email" style="width:100%;margin-bottom:0.5rem;" />
      <input type="password" id="password-input" placeholder="Password" style="width:100%;margin-bottom:0.5rem;" />
      <button id="email-login-btn" style="width:100%;margin-bottom:0.5rem;">Login with Email</button>
      <button id="email-signup-btn" style="width:100%;">Create Account</button>
      <div id="email-auth-message" style="color:red;margin-top:0.5rem;"></div>
    </div>
    -->
  </section>
  <!-- Protected Section -->
  <div id="protected-content" style="display:none;">
    <section id="timeline">
      <h2>Season Timeline</h2>
      <div id="timeline-container">Loading timeline…</div>
    </section>
    <!-- Inserted Team Calendar after Timeline -->
    <section id="calendar">
      <h2>Team Calendar</h2>
      <div style="background:#fff;border:1px solid var(--border-color);padding:1rem;text-align:center;">
        <iframe src="https://calendar.google.com/calendar/embed?src=fll2025.westvalley.cusdk8%40gmail.com&ctz=America%2FLos_Angeles" style="border:0; width:100%; height:600px;" frameborder="0" scrolling="no"></iframe>
      </div>
    </section>
    <section id="roster">
      <h2>Team Roster</h2>
      <div id="roster-container">Loading roster…</div>
    </section>
    <section id="team-progress">
      <h2>Team Progress</h2>
      <div style="margin-bottom:0.5rem;color:#444;font-size:1rem;">
        <strong>Note:</strong> All sessions start at <b>1:30 PM</b> on Sunday and last 60–80 minutes.
      </div>
      <div id="team-progress-container">Loading team progress…</div>
    </section>
    <section id="tasks">
      <h2>Team To‑Dos</h2>
      <div>
        <textarea id="task-input" placeholder="Add one or more tasks (one per line)" rows="3" style="width:70%;max-width:400px;resize:vertical;"></textarea>
        <button id="task-add">Add</button>
      </div>
      <ul id="task-list"></ul>
    </section>
    <!-- Team media section linking to a private Google Drive folder -->
    <section id="media-link">
      <h2>Team Media (Photos & Videos)</h2>
      <p>
        Our team photos and videos are stored in a private Google Drive folder.
        Click the link below to view them.
      </p>
      <div style="text-align:left;margin:1.5rem 0;">
        <a href="team_media.html" style="color:var(--primary-color);text-decoration:underline;font-size:1.1rem;">Go to Team Media Gallery &rarr;</a>
      </div>
    </section>
    <!-- Financials subsection -->
    <section id="financials">
      <h2>Financials</h2>
      <div id="financials-container">Loading financials…</div>
    </section>
    <section id="log-out">
        <button id="logout-btn" style="display:none;">Logout</button>
    </section>
    <footer id="admin-footer" style="display:block;text-align:center;margin-top:1rem;color:#555;">
      <span>Questions or issues? </span>
      <a id="admin-mailto" href="#" style="color:var(--primary-color);text-decoration:underline;">Contact Admin</a>
    </footer>
  </div>
  </main>
  </div>
  <style>
    .main-bounding-box {
      width: 98%;
      max-width: 1000px;
      margin: 1rem auto;
      background: #fff;
      border-radius: 12px;
      border: 2px solid #b3d4fc;
      box-shadow: 0 2px 8px #0001;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      min-height: 400px;
      box-sizing: border-box;
    }
  </style>
  
  <script>
    // --- BEGIN: Your main app code ---
    function buildTable(rows, containerId) {
      if (!rows || rows.length === 0) return;
      const container = document.getElementById(containerId);
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      rows[0].forEach((cell) => {
        const th = document.createElement('th');
        th.textContent = cell;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      for (let i = 1; i < rows.length; i++) {
        const tr = document.createElement('tr');
        rows[i].forEach((cell) => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }
    function buildTimelineTable(rows, containerId) {
      if (!rows || rows.length === 0) return;
      const container = document.getElementById(containerId);
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      rows[0].forEach((cell) => {
        const th = document.createElement('th');
        th.textContent = cell;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      // Helper to get YYYY-MM-DD string
      function toYMD(date) {
        return date.getFullYear() + '-' + (date.getMonth()+1).toString().padStart(2,'0') + '-' + date.getDate().toString().padStart(2,'0');
      }
      const todayObj = new Date();
      const todayYMD = toYMD(todayObj);
      let nextIdx = -1;
      for (let i = 1; i < rows.length; i++) {
        const dateStr = rows[i][0];
        const eventDate = new Date(dateStr);
        const eventYMD = toYMD(eventDate);
        if (!isNaN(eventDate) && eventYMD >= todayYMD) {
          nextIdx = i;
          break;
        }
      }
      for (let i = 1; i < rows.length; i++) {
        const tr = document.createElement('tr');
        const dateStr = rows[i][0];
        const eventDate = new Date(dateStr);
        const eventYMD = toYMD(eventDate);
        let rowClass = '';
        if (!isNaN(eventDate)) {
          if (eventYMD < todayYMD) {
            rowClass = 'timeline-past';
          } else if (i === nextIdx) {
            rowClass = 'timeline-next';
          } else if (i > nextIdx) {
            rowClass = 'timeline-future';
          }
        }
        if (rowClass) tr.classList.add(rowClass);
        rows[i].forEach((cell) => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }
    fetch('csv-files/fll_explore_timeline_2025_26.csv')
      .then((response) => response.text())
      .then((text) => {
        const rows = text.trim().split('\n').map((line) => line.split(','));
        buildTimelineTable(rows, 'timeline-container');
      })
      .catch(() => {
        document.getElementById('timeline-container').textContent =
          'Could not load timeline.';
      });
    fetch('csv-files/fll_parents_list.csv')
      .then((response) => response.text())
      .then((text) => {
        const rows = text.trim().split('\n').map((line) => line.split(','));
        buildTable(rows, 'roster-container');
        // After building the roster table, convert email cells into mailto links
        // and provide a convenient "Email all parents" link. This enhances
        // communication among team parents while keeping the site static.
        const rosterContainer = document.getElementById('roster-container');
        const table = rosterContainer.querySelector('table');
        if (table) {
          const emails = [];
          const bodyRows = table.querySelectorAll('tbody tr');
          bodyRows.forEach((tr) => {
            // Assume the fourth column (index 3) holds the parent email
            const emailCell = tr.cells[3];
            if (emailCell) {
              const email = emailCell.textContent.trim();
              if (email) {
                emailCell.innerHTML = '<a href="mailto:' + email + '">' + email + '</a>';
                emails.push(email);
              }
            }
          });
          if (emails.length > 0) {
            const p = document.createElement('p');
            p.style.marginTop = '0.5rem';
            // Email all parents link
            const emailLink = document.createElement('a');
            emailLink.href = 'mailto:' + emails.join(',');
            emailLink.textContent = 'Email all parents';
            emailLink.style.color = 'var(--primary-color)';
            emailLink.style.textDecoration = 'underline';
            p.appendChild(emailLink);
            // Spacer
            p.appendChild(document.createTextNode(' | '));
            // Parent Conversation link
            const convoLink = document.createElement('a');
            convoLink.href = 'parent_conversation.html';
            convoLink.textContent = 'Parent Conversation';
            convoLink.style.color = 'var(--primary-color)';
            convoLink.style.textDecoration = 'underline';
            p.appendChild(convoLink);
            // Student Conversation link (added after Parent Conversation)
            p.appendChild(document.createTextNode(' | '));
            const studentConvoLink = document.createElement('a');
            studentConvoLink.href = 'student_conversation.html';
            studentConvoLink.textContent = 'Student Conversation';
            studentConvoLink.style.color = 'var(--primary-color)';
            studentConvoLink.style.textDecoration = 'underline';
            p.appendChild(studentConvoLink);
            rosterContainer.appendChild(p);
          }
        }
      })
      .catch(() => {
        document.getElementById('roster-container').textContent =
          'Could not load roster.';
      });

    // --- Team Progress Table ---
    fetch('csv-files/team_session_schedule.csv')
      .then((response) => response.text())
      .then((text) => {
        const rows = text.trim().split('\n').map((line) => line.split(','));
        buildTable(rows, 'team-progress-container');
      })
      .catch(() => {
        document.getElementById('team-progress-container').textContent = 'Could not load team progress.';
      });

    // --- Financials Table ---
    fetch('csv-files/fll_financials_list.csv')
      .then((response) => response.text())
      .then((text) => {
        const rows = text.trim().split('\n').map((line) => line.split(','));
        // For the Notes column, if it contains a semicolon and a file path, make a link
        for (let i = 1; i < rows.length; i++) {
          const notes = rows[i][5] || '';
          if (notes.includes(';')) {
            const [desc, file] = notes.split(';');
            if (file && file.match(/\.(jpg|jpeg|png|pdf)$/i)) {
              rows[i][5] = desc + ` (<a href="${file}" target="_blank">receipt</a>)`;
            } else {
              rows[i][5] = desc;
            }
          }
        }
        // Build the table
        const container = document.getElementById('financials-container');
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        rows[0].forEach((cell) => {
          const th = document.createElement('th');
          th.textContent = cell;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        for (let i = 1; i < rows.length; i++) {
          const tr = document.createElement('tr');
          rows[i].forEach((cell, idx) => {
            const td = document.createElement('td');
            if (idx === 5 && cell.includes('<a ')) {
              td.innerHTML = cell;
            } else {
              td.textContent = cell;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        container.innerHTML = '';
        container.appendChild(table);
      })
      .catch(() => {
        document.getElementById('financials-container').textContent = 'Could not load financials.';
      });

    // --- Server-based To-Do List Implementation ---
  const API_URL = 'https://us-central1-fllex2wv.cloudfunctions.net/api/tasks';
  // Admin email to receive access requests (set this to your address)
  const ADMIN_EMAIL = 'fll2025.westvalley.cusdk8@gmail.com';

  window.addEventListener('DOMContentLoaded', () => {
    console.log('[App] DOMContentLoaded');
    // Hide protected content until login
    const protectedContent = document.getElementById('protected-content');
    const loginSection = document.getElementById('login-section');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');
    const adminMailto = document.getElementById('admin-mailto');
    if (adminMailto && ADMIN_EMAIL) {
      adminMailto.href = 'mailto:' + ADMIN_EMAIL + '?subject=' + encodeURIComponent('FLL Explore Hub Support');
    }

    // Only Google login is enabled
    if (!window.firebase || !window.firebase.auth) {
      console.error('[Firebase] SDK not loaded!');
      return;
    }
    const auth = firebase.auth();
    console.log('[Firebase] Auth initialized');

    loginBtn.onclick = () => {
      console.log('[Auth] Login button clicked');
      // Google sign-in
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => {
        alert('Login failed: ' + err.message);
        console.error('[Auth] Login failed:', err);
      });
    };
    logoutBtn.onclick = () => {
      console.log('[Auth] Logout button clicked');
      auth.signOut();
    };

  // Email login code removed for now (Google login only)

  // Auth state observer with allowUser check
  // Insert access denied message below login section (email login form removed)
  const errorDiv = document.createElement('div');
  errorDiv.id = 'access-denied';
  errorDiv.style.display = 'none';
  errorDiv.style.textAlign = 'center';
  errorDiv.style.margin = '1.5rem auto 0 auto';
  errorDiv.innerHTML = `
    <div style="color:#b00;font-size:1.2rem;font-weight:bold;margin-bottom:1rem;">Access Denied</div>
    <div style="margin-bottom:0.75rem;">Your email is not authorized to access this site.</div>
    <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;margin-bottom:0.5rem;">
      <button id="contact-admin-btn" style="padding:0.5rem 1.0rem;background:#0052a3;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.95rem;">Contact Admin</button>
      <button id="request-access-btn" style="padding:0.5rem 1.0rem;background:#0a7;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.95rem;">Request Access</button>
    </div>
    <div id="admin-confirm" style="display:none;margin-top:0.5rem;color:#0052a3;font-weight:bold;"></div>
  `;
  // Place errorDiv after login section
  if (loginSection && loginSection.parentNode) {
    loginSection.parentNode.insertBefore(errorDiv, loginSection.nextSibling);
  } else {
    document.body.appendChild(errorDiv);
  }

      document.addEventListener('click', async function(e) {
        if (!e.target) return;
        if (e.target.id === 'contact-admin-btn') {
          const msg = document.getElementById('admin-confirm');
          if (ADMIN_EMAIL) {
            const user = auth.currentUser;
            const fromEmail = (user && user.email) ? user.email : '';
            const subject = encodeURIComponent('Access request for FLL Explore hub');
            const body = encodeURIComponent(`Hello Admin,\n\nUser ${fromEmail || '[unknown user]'} is requesting access to the site.\n\nThanks.`);
            window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
            if (msg) {
              msg.textContent = `Opening email to admin (${ADMIN_EMAIL})…`;
              msg.style.display = '';
              setTimeout(() => { msg.style.display = 'none'; }, 3000);
            }
          } else {
            if (msg) {
              msg.textContent = 'No admin email is configured. Set ADMIN_EMAIL at the top of index.html.';
              msg.style.display = '';
              setTimeout(() => { msg.style.display = 'none'; }, 4000);
            }
          }
        } else if (e.target.id === 'request-access-btn') {
          const user = auth.currentUser;
          if (!user) {
            alert('Please sign in first.');
            return;
          }
          try {
            const emailLower = (user.email || '').toLowerCase();
            await db.collection('accessRequests').doc(emailLower).set({
              email: emailLower,
              uid: user.uid || '',
              displayName: user.displayName || '',
              requestedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            const msg = document.getElementById('admin-confirm');
            if (msg) {
              msg.textContent = 'Access request sent. The admin will review it soon.';
              msg.style.display = '';
              setTimeout(() => { msg.style.display = 'none'; }, 4000);
            }
            e.target.disabled = true;
          } catch (err) {
            alert('Failed to submit access request: ' + (err && err.message ? err.message : err));
          }
        }
      });

      // ...existing code...

      async function fetchTasks() {
        try {
          // Add cache-busting query param to avoid 304 caching issues
          const res = await fetch(API_URL + '?_=' + Date.now());
          if (!res.ok) throw new Error('Failed to fetch tasks: ' + res.status);
          const data = await res.json();
          console.log('Fetched tasks:', data);
          // Ensure data is an array of objects with id, text, and done
          if (!Array.isArray(data)) return [];
          return data.filter(obj => obj && typeof obj.text === 'string' && obj.id)
            .map(obj => ({ ...obj, done: !!obj.done }));
        } catch (e) {
          console.error('Error fetching tasks:', e);
          alert('Error fetching tasks: ' + e.message);
          return [];
        }
      }

      async function postTask(text) {
        try {
          const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });
          if (!res.ok) throw new Error('Failed to add task: ' + res.status);
          const data = await res.json();
          console.log('Task added successfully:', data);
          return data;
        } catch (e) {
          console.error('Error adding task:', e);
          alert('Error adding task: ' + e.message);
        }
      }

      async function deleteTask(id) {
        try {
          const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Failed to delete task: ' + res.status);
          const data = await res.json();
          console.log('Task deleted successfully:', data);
          return data;
        } catch (e) {
          console.error('Error deleting task:', e);
          alert('Error deleting task: ' + e.message);
        }
      }

      async function loadTasks() {
        let tasks = await fetchTasks();
        // Show tasks in the order they were added (oldest first)
        const listEl = document.getElementById('task-list');
        listEl.innerHTML = '';
        tasks.forEach((taskObj) => {
          const taskText = (taskObj && typeof taskObj.text === 'string') ? taskObj.text : '[No task]';
          const taskId = (taskObj && taskObj.id) ? taskObj.id : null;
          const done = !!(taskObj && taskObj.done);
          const li = document.createElement('li');
          // Checkbox (leftmost)
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = done;
          checkbox.style.marginRight = '1rem';
          checkbox.addEventListener('change', async () => {
            if (!taskId) return;
            try {
              await fetch(`${API_URL}/${taskId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ done: checkbox.checked })
              });
            } catch (e) {
              alert('Failed to update task status.');
            }
            loadTasks();
          });
          li.appendChild(checkbox);
          // Task text (middle)
          const span = document.createElement('span');
          span.textContent = taskText;
          if (done) {
            span.style.textDecoration = 'line-through';
            span.style.color = '#888';
          }
          li.appendChild(span);
          // Remove button (rightmost)
          if (taskId) {
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Remove';
            removeBtn.style.marginLeft = 'auto';
            removeBtn.addEventListener('click', async () => {
              await deleteTask(taskId);
              loadTasks();
            });
            li.appendChild(removeBtn);
          }
          listEl.appendChild(li);
        });
      }

      document.getElementById('task-add').addEventListener('click', async () => {
        const inputEl = document.getElementById('task-input');
        const lines = inputEl.value.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        if (lines.length) {
          for (const line of lines) {
            await postTask(line);
          }
          inputEl.value = '';
          loadTasks();
        }
      });

      // Initialise the task list when the page loads.
      loadTasks();

      // Auth state observer with allowUser check (moved here after loadTasks definition)
      auth.onAuthStateChanged(async user => {
        console.log('[Auth] Auth state changed:', user);
        if (user) {
          const email = (user.email || '').toLowerCase();
          // Check Firestore allowlist: collection 'allowedUsers', doc id = email
          try {
            const doc = await db.collection('allowedUsers').doc(email).get();
            console.log('[Firestore] Allowlist doc', doc);
            console.log('[Firestore] Allowlist check for', email, 'exists:', doc.exists);
            if (!doc.exists) {
              loginSection.style.display = '';
              protectedContent.style.display = 'none';
              logoutBtn.style.display = 'none';
              userInfo.textContent = '';
              errorDiv.style.display = '';
              return;
            } else {
              errorDiv.style.display = 'none';
              loginSection.style.display = 'none';
              protectedContent.style.display = '';
              logoutBtn.style.display = '';
              userInfo.textContent = 'Logged in as: ' + (user.displayName || user.email);
              // Enable to-do list
              if (typeof loadTasks === 'function') loadTasks();
            }
          } catch (err) {
            console.error('[Firestore] Error checking allowlist:', err);
            errorDiv.style.display = '';
            errorDiv.innerHTML = '<div style="color:#b00;font-size:1.2rem;font-weight:bold;margin-bottom:1rem;">Access Denied</div>' +
              '<div style="margin-bottom:1rem;">Could not verify your access. Please try again later.</div>';
            loginSection.style.display = '';
            protectedContent.style.display = 'none';
            logoutBtn.style.display = 'none';
            userInfo.textContent = '';
          }
        } else {
          errorDiv.style.display = 'none';
          loginSection.style.display = '';
          protectedContent.style.display = 'none';
          logoutBtn.style.display = 'none';
          userInfo.textContent = '';
        }
      });

      // The media section now links to a private Google Drive folder rather than using
      // client-side password protection. No additional script is required here.
   });
    // --- END: Your main app code ---
  </script> 

</body>
</html>